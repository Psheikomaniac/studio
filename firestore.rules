/**
 * @file Firebase Security Rules for balanceUp handball club app
 * @updated 2025-10-27 - PRD-01 Firebase Infrastructure Setup
 *
 * Production-ready rules (PRD-07 hardened)
 * Previously: development mode allowed broad access for import/testing.
 * Now: Team-wide READ for authenticated users, WRITE restricted to admins.
 *
 * Core Philosophy:
 * - Team-wide read access for transparency (handball club team roster)
 * - Write access restricted to admins (team managers/treasurers)
 * - Top-level collections for better query performance
 *
 * Data Structure:
 * - /users/{userId}: User profiles (players)
 * - /fines/{fineId}: Top-level fines collection
 * - /payments/{paymentId}: Top-level payments collection
 * - /beverages/{beverageId}: Beverage catalog
 * - /beverageConsumptions/{consumptionId}: Beverage consumption records
 * - /dues/{dueId}: Team dues (season fees, events, etc.)
 * - /duePayments/{paymentId}: Due payment records
 * - /transactions/{transactionId}: Transaction history
 * - /predefinedFines/{fineId}: Fine templates
 * - /auditLogs/{logId}: Audit trail
 * - /admins/{userId}: Admin role management
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS (Must be defined FIRST!)
    // ============================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // Check if user exists in admins collection
      // To create an admin: manually add document to /admins/{uid} in Firebase Console
      return isSignedIn() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isClubMember(clubId) {
      return isSignedIn() && exists(/databases/$(database)/documents/clubs/$(clubId)/clubMembers/$(request.auth.uid));
    }

    function isClubAdmin(clubId) {
       return isClubMember(clubId) && 
              get(/databases/$(database)/documents/clubs/$(clubId)/clubMembers/$(request.auth.uid)).data.role in ['owner', 'admin'];
    }

    // No development bypass. All access must satisfy collection-specific rules below.

    // ============================================
    // CLUBS & TEAMS
    // ============================================
    
    match /clubs/{clubId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isClubAdmin(clubId) || (create && request.auth.uid == request.resource.data.ownerUid);
      
      match /clubMembers/{memberUid} {
        allow read: if isSignedIn();
        allow create, update, delete: if isClubAdmin(clubId) || (request.auth.uid == memberUid); 
      }
    }

    match /teams/{teamId} {
      allow read: if isSignedIn();
      // Create: Allowed if standalone OR if part of club (and user is club admin)
      allow create: if isSignedIn() && (
        !('clubId' in request.resource.data) || isClubAdmin(request.resource.data.clubId)
      );
      
      // Update: Team Admin OR Club Admin (if linked)
      allow update: if isTeamAdmin(teamId) || (
        'clubId' in resource.data && isClubAdmin(resource.data.clubId)
      );
      
      match /teamMembers/{memberUid} {
         allow read: if isSignedIn();
         allow create, update, delete: if isTeamAdmin(teamId) || (
             get(/databases/$(database)/documents/teams/$(teamId)).data.clubId != null && 
             isClubAdmin(get(/databases/$(database)/documents/teams/$(teamId)).data.clubId)
         ) || (request.auth.uid == memberUid && request.method == 'delete'); // Allow leaving
      }
    }

    function isTeamMember(teamId) {
      return isSignedIn() && exists(/databases/$(database)/documents/teams/$(teamId)/teamMembers/$(request.auth.uid));
    }

    function isTeamAdmin(teamId) {
       return isTeamMember(teamId) && 
              get(/databases/$(database)/documents/teams/$(teamId)/teamMembers/$(request.auth.uid)).data.role in ['owner', 'admin'];
    }

    // ============================================
    // USERS (Players)
    // ============================================

    match /users/{userId} {
      // Team-wide read access (transparency for team roster)
      allow get, list: if isSignedIn();

      // Only owner or admin can create/update profile
      allow create: if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isAdmin();

      // Only admin can delete players
      allow delete: if isAdmin();

      match /fines/{fineId} {
        // Team-wide read; write only by admins
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin();
      }

      match /payments/{paymentId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin();
      }

      match /duePayments/{paymentId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin();
      }

      match /beverageConsumptions/{consumptionId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAdmin();
      }
    }

    // ============================================
    // FINES (Top-level collection)
    // ============================================

    match /fines/{fineId} {
      // Team-wide read access (everyone can see fines)
      allow get, list: if isSignedIn();

      // Only admins can create, update, or delete fines
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // PAYMENTS (Top-level collection)
    // ============================================

    match /payments/{paymentId} {
      // Team-wide read access
      allow get, list: if isSignedIn();

      // Only admins can manage payments
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // BEVERAGES (Catalog)
    // ============================================

    match /beverages/{beverageId} {
      // Everyone can read the beverage catalog
      allow get, list: if isSignedIn();

      // Only admins can manage catalog
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // BEVERAGE CONSUMPTIONS
    // ============================================

    match /beverageConsumptions/{consumptionId} {
      // Team-wide read access
      allow get, list: if isSignedIn();

      // Only admins can manage consumption records
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // DUES (Team fees, events, etc.)
    // ============================================

    match /dues/{dueId} {
      // Everyone can read dues
      allow get, list: if isSignedIn();

      // Only admins can create/update/delete dues
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // DUE PAYMENTS
    // ============================================

    match /duePayments/{paymentId} {
      // Team-wide read access
      allow get, list: if isSignedIn();

      // Only admins can manage due payments
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // TRANSACTIONS (History/Ledger)
    // ============================================

    match /transactions/{transactionId} {
      // Team-wide read access
      allow get, list: if isSignedIn();

      // Only admins can create transactions
      allow create: if isAdmin();
      // Updates/deletes are denied by default (immutable ledger)
    }

    // ============================================
    // PREDEFINED FINES (Templates)
    // ============================================

    match /predefinedFines/{fineId} {
      // Everyone can read fine templates
      allow get, list: if isSignedIn();

      // Only admins can manage templates
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // AUDIT LOGS
    // ============================================

    match /auditLogs/{logId} {
      // Only admins can read audit logs
      allow get, list: if isAdmin();

      // Only admins can create audit logs
      allow create: if isAdmin();
      // No updates/deletes (immutable)
    }

    // ============================================
    // ADMINS (role management)
    // ============================================
    match /admins/{uid} {
      // Only admins can read or write admin documents
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // No additional admin management or collection group wildcard rules required.
  }
}