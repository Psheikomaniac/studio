# CLAUDE.md — balanceUp Studio

## Project
Club finance management app (Vereinsverwaltung) for sports teams.
Manages players, fines, payments, dues, and beverages with real-time data.

## Tech Stack
- Next.js 16 (App Router) / React 19 / TypeScript 5 (strict)
- Firebase Firestore + Auth
- Tailwind CSS + shadcn/ui (Radix primitives)
- Vitest + Playwright
- i18next (DE/EN)

## Commands
| Command | Purpose |
|---|---|
| `npm run dev` | Dev server (port **9002**, Turbopack) |
| `npm run build` | Production build |
| `npm run typecheck` | TypeScript check (MUST pass before commit) |
| `npm run lint` | ESLint |
| `npm test` | All unit tests (Vitest) |
| `npm run test:unit` | Unit tests only |
| `npm run test:integration` | Integration tests (needs emulator) |
| `npm run test:e2e` | E2E tests (Playwright) |
| `npm run test:coverage` | Coverage report |
| `npm run ci` | Full CI: typecheck + lint + test:coverage |
| `npm run emulator:start` | Firebase Emulator (Firestore + Auth + UI) |
| `npm run emulator:test` | Run integration tests via emulator |

## Architecture Rules

### Service Layer (MANDATORY)
All Firestore operations go through service classes in `src/services/`.
Components NEVER import Firebase directly.

```
src/services/
├── base.service.ts          # Abstract CRUD base class
├── players.service.ts       # Player management
├── fines.service.ts         # Fine management
├── payments.service.ts      # Payment management
├── dues.service.ts          # Dues/fees + due payments
├── beverages.service.ts     # Beverage catalog + consumption
├── predefined-fines.service.ts # Predefined fines catalog (team-scoped)
├── balance.service.ts       # Balance calculations
├── teams.service.ts         # Team management + invites
├── clubs.service.ts         # Club management
├── types.ts                 # ServiceResult<T>, QueryOptions, etc.
└── index.ts                 # Barrel exports
```

### State Management
- React Context + Hooks only (no Redux/Zustand)
- Custom hooks in `src/hooks/` for domain logic

### Error Handling
- Services return `ServiceResult<T>` with `{ success, data?, error? }`
- Custom errors in `src/firebase/errors.ts`

## Firestore Path Structure (V3 — team-scoped)

Player-scoped data (nested under team → player):
```
teams/{teamId}/
  players/{playerId}/
    fines/{fineId}
    payments/{paymentId}
    duePayments/{duePaymentId}
    beverageConsumptions/{consumptionId}
  predefinedFines/{id}
  teamMembers/{uid}
```

Club membership:
```
clubs/{clubId}/
  clubMembers/{uid}
```

Top-level shared collections:
```
beverages/          # Queried directly in pages
dues/               # Due definitions
teamInvites/{code}  # Team invite codes
```

Static data (not Firestore):
- Sample players, fines, payments, beverages, dues are in `src/lib/static-data.ts`

## Conventions

### Imports
- Always use `@/` path alias (maps to `src/`)
- Example: `import { Player } from '@/lib/types'`

### Naming
- Files: kebab-case (`players.service.ts`, `use-player-balances.ts`)
- Components: PascalCase (`PlayerCard`, `FinesList`)
- Services: PascalCase + "Service" suffix (`FinesService`)
- Hooks: camelCase + "use" prefix (`useAllTransactions`)
- Types/Interfaces: PascalCase (`Player`, `Fine`, `ServiceResult<T>`)

### Components
- Functional components only, `'use client'` directive where needed
- UI primitives in `src/components/ui/` (shadcn/ui — do not modify)
- Feature components in `src/components/[feature]/`

### Data Types
- All dates: ISO strings (`"2025-11-02T14:30:00.000Z"`)
- All amounts: EUR (number, not cents)
- Core types in `src/lib/types.ts` — always reuse, never duplicate

## Testing

### Structure
```
tests/
├── unit/              # Vitest unit tests
│   └── services/      # Service-specific tests
├── integration/       # Firebase Emulator tests
│   └── helpers/       # Test builders + seed data
├── fixtures/          # Test data generators
├── mocks/             # Firebase mocks
└── setup.ts           # Global test setup

e2e/                   # Playwright E2E tests
├── fixtures/          # Auth fixtures
├── helpers/           # Test data helpers
├── page-objects/      # Page Object Model
└── *.spec.ts          # Test specs
```

### Running Tests
- Unit: `npm test` (Vitest, happy-dom)
- Integration: `npm run emulator:test` (starts emulator automatically)
- E2E: `npm run test:e2e` (Playwright)
- Coverage thresholds: 7.5% lines/functions/statements, 12% branches

## Gotchas

- Dev server runs on **port 9002**, not 3000
- Firebase Emulator ports: Firestore 8080, Auth 9099, UI 4000
- `.env.local` and `.env.production` contain secrets — never commit
- `src/components/ui/` is auto-generated by shadcn — avoid manual edits
- `beverages` and `dues` collections are still accessed directly in some pages (legacy, not yet migrated to services)
- Safari uses memory-only Firestore cache (no persistent IndexedDB)
